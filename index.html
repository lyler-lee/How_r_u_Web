<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°ì • ë¶„ì„ AI í”„ë¡œì íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { text-align: center; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; margin: 20px 0; }
        .result { margin-top: 20px; padding: 20px; background: #f5f5f5; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #preview { max-width: 300px; margin: 10px auto; }
        .loading { display: flex; align-items: center; justify-content: center; }
        .spinner { 
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ ê°ì • ë¶„ì„ AI í”„ë¡œì íŠ¸</h1>
        <p>ì–¼êµ´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì—¬ ê°ì •ì„ ë¶„ì„í•´ë³´ì„¸ìš”!</p>
        
        <div class="upload-area">
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <button onclick="document.getElementById('imageInput').click()">ğŸ“· ì´ë¯¸ì§€ ì„ íƒ</button>
            <div id="preview"></div>
        </div>
        
        <button id="analyzeBtn" onclick="analyzeEmotion()" disabled>ğŸ” ê°ì • ë¶„ì„ ì‹œì‘</button>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        let selectedFile = null;
        let isAnalyzing = false; // âœ… ë³€ìˆ˜ëª… ìˆ˜ì •
        
        // íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë¸Œë¼ìš°ì € ë©ˆì¶¤ ë°©ì§€)
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview').innerHTML = 
                        `<img src="${e.target.result}" style="max-width: 100%; height: auto;">`;
                };
                reader.readAsDataURL(file);
                document.getElementById('analyzeBtn').disabled = false;
                
                // âœ… ë¸Œë¼ìš°ì € ë©ˆì¶¤ ë°©ì§€: íŒŒì¼ ê°’ ì´ˆê¸°í™”
                this.value = null;
            }
        });
        
        // âœ… íŒŒì¼ ì„ íƒ ì‹œ ë¸Œë¼ìš°ì € ë©ˆì¶¤ ë°©ì§€
        document.getElementById('imageInput').addEventListener('click', function(e) {
            e.target.value = '';
        });
        
        // ë¶„ì„ ë²„íŠ¼ ìƒíƒœ ê´€ë¦¬
        function setAnalyzeButtonState(analyzing) {
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzing) {
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = 'â³ ë¶„ì„ ì¤‘...';
                analyzeBtn.style.background = '#666';
            } else {
                analyzeBtn.disabled = selectedFile ? false : true;
                analyzeBtn.innerHTML = 'ğŸ” ê°ì • ë¶„ì„ ì‹œì‘';
                analyzeBtn.style.background = '';
            }
        }

        // âœ… ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ ì¶”ê°€
        function displayResult(result) {
            const resultDiv = document.getElementById('result');
            
            let emotionDisplay = '';
            if (result.emotion) {
                const emotionEmojis = {
                    'Happy': 'ğŸ˜Š', 'Sad': 'ğŸ˜¢', 'Angry': 'ğŸ˜ ',
                    'Fear': 'ğŸ˜¨', 'Surprise': 'ğŸ˜²', 'Disgust': 'ğŸ¤¢',
                    'Neutral': 'ğŸ˜'
                };
                
                emotionDisplay = `
                    <h3>${emotionEmojis[result.emotion.label] || 'ğŸ­'} ${result.emotion.label}</h3>
                    <p><strong>ì‹ ë¢°ë„:</strong> ${result.emotion.confidence}%</p>
                    <details>
                        <summary>ìƒì„¸ í™•ë¥ </summary>
                        ${Object.entries(result.emotion.probabilities).map(([emotion, prob]) => 
                            `<p>${emotion}: ${prob}%</p>`
                        ).join('')}
                    </details>
                `;
            }
            
            resultDiv.innerHTML = `
                <h3>âœ… ë¶„ì„ ì™„ë£Œ!</h3>
                <p><strong>ê²€ì¶œëœ ì–¼êµ´ ìˆ˜:</strong> ${result.face_count}ê°œ</p>
                ${emotionDisplay}
                ${result.annotated_image ? 
                    `<img src="data:image/jpeg;base64,${result.annotated_image}" style="max-width: 100%; margin-top: 10px;">` 
                    : ''}
            `;
            resultDiv.style.display = 'block';
        }

        async function analyzeEmotion() {
            // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
            if (isAnalyzing) {
                console.log('ì´ë¯¸ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...');
                return;
            }
        
            if (!selectedFile) {
                console.log('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            isAnalyzing = true;
            setAnalyzeButtonState(true);
            
            // âœ… ê¸°ì¡´ result div ì‚¬ìš©
            const resultDiv = document.getElementById('result');
            
            try {
                // ë¡œë”© í‘œì‹œ
                resultDiv.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>ê°ì • ë¶„ì„ ì¤‘...</span>
                    </div>
                `;
                resultDiv.style.display = 'block';

                const formData = new FormData();
                formData.append('image', selectedFile);

                console.log('ìš”ì²­ ì‹œì‘:', new Date().toISOString());
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('ì„±ê³µ ì‘ë‹µ:', result);
                    displayResult(result);
                } else {
                    const errorText = await response.text();
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${errorText}`);
                }
                
            } catch (error) {
                console.error('ìš”ì²­ ì˜¤ë¥˜:', error);
                resultDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ˜”</div>
                        <div style="font-size: 1.2rem; color: #ff6b6b;">ë¶„ì„ ì‹¤íŒ¨</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">${error.message}</div>
                    </div>
                `;
            } finally {
                isAnalyzing = false;
                setAnalyzeButtonState(false);
            }
        }
        
        // âœ… ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ëª¨ë‹ˆí„°ë§ (ë””ë²„ê¹…ìš©)
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            console.log('ğŸš€ Fetch ìš”ì²­:', args[0]);
            return originalFetch.apply(this, args)
                .then(response => {
                    console.log('âœ… Fetch ì‘ë‹µ:', response.status);
                    return response;
                })
                .catch(error => {
                    console.error('âŒ Fetch ì˜¤ë¥˜:', error);
                    throw error;
                });
        };
    </script>
</body>
</html>

